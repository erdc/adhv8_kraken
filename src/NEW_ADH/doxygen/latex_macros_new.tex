% all equations utilize {align} from amsmath package

\newcommand*{\lrp}[1]{(#1)}
\newcommand*{\lrb}[1]{[{#1}]}
\newcommand*{\lrpb}[1]{\big({#1}\big)}
\newcommand*{\lrbb}[1]{\big[{#1}\big]}
\newcommand*{\lrpbb}[1]{\bigg({#1}\bigg)}
\newcommand*{\lrbbb}[1]{\bigg[{#1}\bigg]}

\newcommand{\ith}{i^{\,th}}
\newcommand{\jth}{j^{\,th}}

% ------------------------------------------------------------
% equation definitions ---------------------------------

\newcommand*{\Eqq}[1]{Equation (\ref{eqn:#1})}
\newcommand*{\eqq}[1]{Eq.\,(\ref{eqn:#1})}
\newcommand*{\eqqs}[2]{Eqs.\,(\ref{eqn:#1})-(\ref{eqn:#2})}

\newcommand*{\EqAlign}[2]{
\begin{align} 
\label{eqn:{#1}}
#2
\end{align}
}

\newcommand*{\EqArray}[2]{
\begin{eqnarray} 
\label{eqn:{#1}}
#2
\end{eqnarray}
}

% ------------------------------------------------------------
% figure definitions -------------------------------------

\newcommand*{\Fig}[1]{Figure \,(\ref{fig:#1})}
\newcommand*{\fig}[1]{Fig.\,(\ref{fig:#1})}
\newcommand*{\figs}[2]{Figs.\,(\ref{fig:#1})-(\ref{fig:#2})}

% ------------------------------------------------------------
% geometry definitions --------------------------------

% normals
\newcommand{\nrml}{\mathbf{n}}

% dot products
\newcommand*{\dotp}[2]{{#1} \, \cdot \, {#2}}
\newcommand*{\dotpb}[2]{\mathbf{{#1}} \, \cdot \, (\mathbf{{#2}})}

% tensors
\newcommand*{\rttensor}[1]{\overline{\overline{#1}}}
\newcommand*{\tensor}[1]{\overline{\overline{{\mathbf{#1}}}}}

% gradients and derivatives
\newcommand*{\deriv}[2]{\frac{\,\partial{#1}}{\,\partial{#2}}}
\newcommand*{\ppartial}[2]{\frac{\,\partial #1}{\,\partial #2}}
\newcommand*{\dderiv}[2]{\frac{\,\partial^2{#1}}{\,\partial{#2}^2}}

\newcommand{\ddx}{\frac{\,\partial}{\,\partial x}}
\newcommand{\ddy}{\frac{\,\partial}{\,\partial y}}
\newcommand{\ddz}{\frac{\,\partial}{\,\partial z}}
\newcommand{\ddt}{\frac{\,\partial}{\,\partial t}}

\newcommand*{\bnabla}[1]{\mathbf{\nabla^{#1}} }   % #1 is dimension here
\newcommand{\bbnabla}{\mathbf{\nabla}} 
\newcommand{\grad}{\mathbf{\nabla}}

% ------------------------------------------------------------
% velocity definitions -----------------------------------

% regular velocity,
\newcommand{\vel}{\mathbf{v}}
\newcommand{\velh}{\mathbf{v}^{\,h}}
\newcommand{\uh}{u^{\,h}}
\newcommand{\vh}{v^{\,h}}
\newcommand{\wh}{w^{\,h}}

% relative velocity
\newcommand{\velr}{\mathbf{v}_r}
\newcommand{\velrh}{\mathbf{v}^{\,h}_r}

% depth-averaged velocity
\newcommand*{\velb}[1]{\overline{\mathbf{v}}^{\,#1}}
\newcommand*{\ub}[1]{\overline{u}^{\,#1}}
\newcommand*{\vb}[1]{\overline{v}^{\,#1}}

% transport velocity
\newcommand*{\velc}[2]{\mathbf{v}_{#2}^{\,{#1}}}           % {#1} = h, {#2} bl, sl, t, etc || con velocity
\newcommand*{\velrc}[2]{\mathbf{v}_{{#2},r\,}^{\,{#1}}}   % {#1} = h, {#2} bl, sl, t, etc || relative con velocity

% velocity derivatives
\newcommand{\dudx}{\frac{\partial u}{\partial x}}
\newcommand{\dudy}{\frac{\partial u}{\partial y}}
\newcommand{\dudz}{\frac{\partial u}{\partial z}}

\newcommand{\dvdx}{\frac{\partial v}{\partial x}}
\newcommand{\dvdy}{\frac{\partial v}{\partial y}}
\newcommand{\dvdz}{\frac{\partial v}{\partial z}}

\newcommand{\dwdx}{\frac{\partial v}{\partial x}}
\newcommand{\dwdy}{\frac{\partial v}{\partial y}}
\newcommand{\dwdz}{\frac{\partial v}{\partial z}}

\newcommand{\duhdx}{\frac{\partial \uh}{\partial x}}
\newcommand{\dvhdy}{\frac{\partial \vh}{\partial y}}
\newcommand{\dwhdz}{\frac{\partial \wh}{\partial z}}

% fluxes
\newcommand{\fluxbcn}{q_n}
\newcommand*{\fluxSedlib}[1]{q_{#1}^{sedlib}}


% ------------------------------------------------------------
% basis functions ---------------------------------------

\newcommand*{\phidd}[1]{\phi_{#1}}            % 2D basis functions
\newcommand*{\phiddd}[1]{\omega_{#1}}    % 3D basis functions

% 2d gradients
\newcommand*{\dphiddx}[1]{\frac{\partial{\,\phidd_{#1}}}{{\partial{x}}}}
\newcommand*{\dphiddy}[1]{\frac{\partial{\,\phidd_{#1}}}{{\partial{y}}}}
\newcommand*{\dphiddz}[1]{\frac{\partial{\,\phidd_{#1}}}{{\partial{z}}}}

% 3d gradients
\newcommand*{\dphidddx}[1]{\frac{\partial{\,\phiddd_{#1}}}{{\partial{x}}}}
\newcommand*{\dphidddy}[1]{\frac{\partial{\,\phiddd_{#1}}}{{\partial{y}}}}
\newcommand*{\dphidddz}[1]{\frac{\partial{\,\phiddd_{#1}}}{{\partial{z}}}}

% ------------------------------------------------------------
% integral definitions -----------------------------------

\newcommand*{\intd}[1]{\oint {#1} \, ds} 
\newcommand*{\intdd}[1]{\int_{\Omega^{2d}} {#1} \, d\Omega^{2d}}
\newcommand*{\intddd}[1]{\int_{\Omega^{3d}} {#1} \, d\Omega^{3d}}
\newcommand*{\intg}[3]{\int_{\Omega^{{#2}}_{{#3}}} {#1} \, d\Omega}  % {#1} = integrand, {#2} = 2d/3d, {#3} = e
\newcommand*{\intgb}[3]{\oint_{\partial \Omega^{{#2}}_{{#3}}} {#1} \, d(\,\bound^{{#2}}_{{#3}})}  % general integral
\newcommand*{\intgbs}[3]{\int_{\partial \Omega^{{#2}}_{{#3}}} {#1} \, d\,\Gamma_{{#3}}}  % general boundary integral with gamma
\newcommand*{\intgda}[3]{\int_{\partial \Omega^{{#2}}_{{#3}}} {#1} \, da}  % general boundary integral with gamma

\newcommand*{\intbe}[2]{\int_{\Gamma_{\,#2}}{#1} \, d\,\Gamma}  % general boundary integral
\newcommand*{\intesw}[1]{\int_{\swface}{#1} \, d\,\Gamma_e}  % general boundary integral
\newcommand*{\inteb}[1]{\int_{\bface}{#1} \, d\,\Gamma_e}  % general boundary integral
\newcommand*{\intes}[1]{\int_{\sface}{#1} \, d\,\Gamma_e}  % general boundary integral
\newcommand*{\intv}[2]{\int_{\Omega^{3d}_{#2}} {#1} \, d\Omega}
\newcommand*{\inta}[2]{\int_{\Omega^{2d}_{#2}} {#1} \, d\Omega}

% ------------------------------------------------------------
% shallow water related definitions -----------------

% SW grid
\newcommand{\bound}{\partial \Omega}
\newcommand{\bface}{\Gamma^{\,b}}
\newcommand{\sface}{\Gamma^{\,\eta}}
\newcommand{\swface}{\Gamma^{\,sw}}

% generic discrete function
\newcommand{\fh}{f^{\,h}} 

% generic function depth-average
\begin{equation}
\label{#1}
\overline{f} = \frac{1}{H} \int_{z_b}^{z_\elev} \, f \, dz
\end{equation}

% depth
\newcommand*{\depth}[1]{H^{\,{#1}}}

% residual definitions
\newcommand*{\resid}[3]{R_{\,#1}^{\,{#2}{#3}}}                           % {#1} test function id, {#2} constituent id, {#3} residual name
\newcommand*{\residDA}[3]{\overline{R}_{\,#1}^{\,{#2}{#3}}}        % {#1} test function id, {#2} constituent id, {#3} residual name

% petrov-galerkin definitions
\newcommand{\tauZ}{\tau_{\,z}}
\newcommand*{\tauPG}[1]{\tau^{\,{#1}}}					% {#1} = 1d,2d,3d
\newcommand*{\supg}[3]{P_{{#1},{#3}}^{\,{#2}}}			         % {#1} = test function index, {#2} = eqn label, {#3} = e (mandatory here)
\newcommand*{\supgDA}[3]{\overline{P}_{{#1},{#3}}^{\,{#2}}}     % {#1} = test function index, {#2} = eqn label, {#3} = e (mandatory here)

% source definitions
\newcommand*{\srcGen}[3]{S_{{#1}}^{\,{#3}{#2}}} % {#1} = bl,sl,etc, {#2} = h, {#3} con id
\newcommand*{\src}[1]{S_{#1}}
\newcommand*{\srch}[1]{S_{#1}^{\,h}}

% pressure definitions
\newcommand*{\prs}[1]{P_{#1}}
\newcommand*{\orsh}[1]{P_{#1}^{\,h}}

% kinematic condition definitions
\newcommand{\etah}{\eta^{\,h}}
\newcommand{\bh}{b^{\,h}}

% constituent concentrations
\newcommand*{\ctrns}[3]{c_{#3}^{\,{#2},{#1}}}             % {#1} = h, {#2} = con id, {#3} bl, cl, etc

% constituent definitions
\newcommand{\ch}{c^{\,h}}
\newcommand{\cjh}{c^{\,j,\,h}}
\newcommand{\ctbjh}{(c^{\,j,\,h\,}_{bl}\,\delta^{\,h\,})}

% bed thickness
\newcommand*{\thick}[1]{\delta^{\,{#1}}}

% bed load variable (c * t)
\newcommand*{\cbl}[3]{c_{#3}^{\,{#2},{#1}}\,\thick{#1}}             % {#1} = h, {#2} = con id, {#3} bl, cl, etc

% diffusion tensor
\newcommand{\diffTensorSW}{T}
\newcommand{\diffTensorTRN}{D}
\newcommand*{\diffTensor}[4]{\mathbf{#3}_{#1}^{\,{#4}{#2}}}                      % {#1} = bl,sl,etc, {#2} = h, {#3} tensor var, {#4} con id
\newcommand*{\diffTensorDA}[4]{\overline{\mathbf{#3}}_{{#1}}^{\,{#4}{#2}}}   % {#1} = bl,sl,etc, {#2} = h, {#3} tensor var, {#4} con id 

% ------------------------------------------------------------
% continuity equations -----------------------------
% strong continuity ----------------------------------
\newcommand{\strgCont}{\dudx+\dvdy+\dwdz}
\newcommand{\strgContGrad}{\bnabla \cdot \vel}
\newcommand{\strgContH}{\duhdx+\dvhdy+\dwhdz}
\newcommand{\strgContGradH}{\bnabla \cdot \velh}
\newcommand{\strgDACont}{\deriv{\depth}{t} + (\bnabla{2d} \cdot \depth \velb{})}
\newcommand{\strgDAContH}{\deriv{\depth^h}{t} + (\bnabla{2d} \cdot \depth \velb{h})}

% weak continuity ----------------------------------
% boundary integrals
\newcommand*{\explicitContBc}[2]{ \intgbs{{#1} \, \fluxbcn}{#2}{e} }
\newcommand*{\implicitContBc}[3]{ \intgbs{{#1} \, (\dotp{{#2}}{\nrml})}{#3}{e} }

% ------------------------------------------------------------
% momentum equations ------------------------------
\newcommand*{\bodyTime}[4] {\deriv{}{t} \intg{({#3}{#4})}{#1}{#2}}                                                        % {#1} = 2d/3d, {#2} = e, {#3} = phi, {#4} = var
\newcommand*{\bodySource}[4]           {\intg{({#3}{#4})}{#1}{#2}}                                                          % {#1} = 2d/3d, {#2} = e, {#3} = phi, {#4} = var
\newcommand*{\bodyCoriolis}[4]          {\intg{\lrpb{{#3}\,{#4}\,f}}{#1}{#2}}                                              % {#1} = 2d/3d, {#2} = e, {#3} = phi. {#4} = u,v
\newcommand*{\bodyPressure}[5]        {\intg{\lrpbb{g \deriv{#3}{#4} \frac{{#5}}{\rho_o}}}{#1}{#2}}       % {#1} = 2d/3d, {#2} = e, {#3} = phi, {#4} = x,y
\newcommand*{\bodyPressureDD}[5]   {\intg{\lrpbb{g \deriv{#3}{#4} \frac{1}{2} {#5}^2}}{#1}{#2}}        % {#1} = 2d/3d, {#2} = e, {#3} = phi, {#4} = x,y
\newcommand*{\bodyDiffusion}[4]         {\intg{\lrpb{\dotp{\bnabla{#1}{#3}}{#4}} }{#1}{#2}}                    % {#1} = 2d/3d, {#2} = e, {#3} = phi, {#4} = stress variable
\newcommand*{\bodyConv}[4]              {\intg{\lrpb{\dotp{\bnabla{#1}{#3}}{#4}}  }{#1}{#2}}                    % {#1} = 1rst dot prod :: {#2} = 2nd dot prod :: {#3} = 2d/3d :: {#4} = e
\newcommand*{\bodyFriction}[5]           {\intg{ {#3} \lrpbb{\frac{1}{2}c_f \,{#4} ||{#5}||}} {#1}{#2}}          % {#1} = 2d/3d, {#2} = e, {#3} = phi, {#4} = u,v, {#5} = vel vector
\newcommand*{\bodyStress}[4]             {\intg{ {#3}\frac{#4}{\rho_o} } {{#1}}{{#2}}  }                              % {#1} = 2d/3d,sw,etc., {#2} = e, {#3} = phi, {#4} = stress variable
\newcommand*{\bodySUPG}[1]{{#1}}

% \newcommand*{\intbe}[2]{\int_{\Gamma_{\,#2}}{#1} \, d\,\Gamma}  % general boundary integral
\newcommand*{\bcStress}[4]{         \intbe{ {#3}\frac{#4}{\rho_o} } {{#1}_{#2}}  }                       % {#1} = 2d/3d,sw,etc., {#2} = e, {#3} = phi, {#4} = stress variable
\newcommand*{\bcFriction}[5]{       \intbe{ {#3} \lrpbb{\frac{1}{2}c_f \,{#4} ||{#5}||}} {#1_#2}  }      % {#1} = 2d/3d,sw,etc., {#2} = e, {#3} = phi, {#4} = u,v, {#5} = vel vector
\newcommand*{\bcConv}[4]{           \intbe{ {#3} \lrpb{\dotp{{#4}}{\nrml}} } {#1_#2}  }                  % {#1} = 2d/3d,sw,etc., {#2} = e, {#3} = phi, {#4} = vel * u,v
\newcommand*{\bcPressure}[5]{     \intbe{ {#3} \lrpbb{\frac{g\, #4}{\rho_o} \, n_{#5} } }{#1_#2}  }   % {#1} = 2d/3d,sw,etc., {#2} = e, {#3} = phi, {#4} = P, {#5} = x,y
\newcommand*{\bcPressureDD}[5]{\intbe{ {#3} \lrpbb{g\,\frac{1}{2} {#4}^2 \, n_{#5} } }{#1_#2}  }   % {#1} = 2d/3d,sw,etc., {#2} = e, {#3} = phi, {#4} = P, {#5} = x,y
\newcommand*{\bcDiff}[4]{              \intbe{ {#3} \lrpb{\dotp{#4}{\nrml}}  }{#1_#2}  }                 % {#1} = 2d/3d,sw,etc.,  {#2} = e, {#3} = phi, {#4} = stress variable
\newcommand*{\bcKinematic}[5]{    \intbe{ {#3} \lrpbb{\deriv{#4}{t} - #5}\,n_z }{#1_#2}  }  
  
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Weak SW-2D equations 
% {#1} = include "e", {#2} = include i on basis function, {#3} = include discrete h
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 
\newcommand*{\weakSWDAcont}[3]{
\residDA{#2}{}{c} = & \sum_{e}  
\bigg[  
        \bodyTime{\,2d}{#1}{\phidd{#2}}{\depth{#3}}
     -  \bodyConv{\,2d}{#1}{\phidd{#2}}{(\velb{#3} \, \depth{#3})}
    +  \bcConv{}{#1}{\phidd{#2}}{(\velb{#3} \, \depth{#3})}
    +  \bodySUPG{\supgDA{#2}{c}{#1}} 
\bigg]
}

\newcommand*{\weakSWMxDD}[3]{
\residDA{#2}{}{mx} = & \sum_{e}  
\bigg[  
        \bodyTime{\,2d}{#1}{\phidd{#2}}{\,\ub{#3}\depth{#3}}
     -  \bodyConv{\,2d}{#1}{\phidd{#2}}{(\velb{#3} \, \ub{#3}\depth{#3})}
     -  \bodyCoriolis{\,2d}{#1}{\phidd{#2}}{\depth{#3}\,\vb{#3}}                                                                \nonumber \\
&  -   \bodyPressureDD{\,2d}{#1}{\phidd{#2}}{x}{(\depth{#3})} 
    +  \bodyDiffusion{\,2d}{#1}{\phidd{#2}}{\depth{#3}\,\diffTensorDA{x}{#3}{\diffTensorSW}{}}
    +  \bodyFriction{\,2d}{#1}{\phidd{#2}}{\ub{#3}}{\velb{#3}}                                            \nonumber \\    
&  -   \bodyStress{\,2d}{#1}{\phidd{#2}}{\lrpb{\tau_{winds,x}^{\,#3} + \tau_{waves,x}^{\,#3}}} 
    +  \bcConv{}{#1}{\phidd{#2}}{(\velb{#3} \, \ub{#3}\depth{#3})}
    +  \bcPressureDD{}{#1}{\phidd{#2}}{(\depth{#3})}{x}                                                                      \nonumber \\
&  -  \bcDiff{}{#1}{\phidd{#2}}{\depth{#3}\,\diffTensorDA{x}{#3}{\diffTensorSW}{}}                                                                   
    +  \bodySUPG{\supgDA{#2}{mx}{#1}} 
\bigg]
}

\newcommand*{\weakSWMyDD}[3]{
\residDA{#2}{}{my} = & \sum_{e}  
\bigg[  
        \bodyTime{\,2d}{#1}{\phidd{#2}}{\,\vb{#3}\depth{#3}}
     -  \bodyConv{\,2d}{#1}{\phidd{#2}}{(\velb{#3} \, \vb{#3}\depth{#3})}
     +  \bodyCoriolis{\,2d}{#1}{\phidd{#2}}{\depth{#3}\,\ub{#3}}                                                                \nonumber \\
&  -   \bodyPressureDD{\,2d}{#1}{\phidd{#2}}{y}{(\depth{#3})} 
    +  \bodyDiffusion{\,2d}{#1}{\phidd{#2}}{\depth{#3}\,\diffTensorDA{y}{#3}{\diffTensorSW}{}}  
    +  \bodyFriction{\,2d}{#1}{\phidd{#2}}{\vb{#3}}{\velb{#3}}                                            \nonumber \\    
&  -   \bodyStress{\,2d}{#1}{\phidd{#2}}{\lrpb{\tau_{winds,y}^{\,#3} + \tau_{waves,y}^{\,#3}}} 
    +  \bcConv{}{#1}{\phidd{#2}}{(\velb{#3} \, \vb{#3}\depth{#3})}
    +  \bcPressureDD{}{#1}{\phidd{#2}}{(\depth{#3})}{y}                                                                      \nonumber \\
&  -  \bcDiff{}{#1}{\phidd{#2}}{\depth{#3}\, \diffTensorDA{y}{#3}{\diffTensorSW}{}}                                                                   
    +  \bodySUPG{\supgDA{#2}{my}{#1}} 
\bigg]
}

% 2D SW SUPG TERMS
% {#1} = 2d/3d, {#2} = include "e",  {#3} test function index, {#4} tx1, {#5} tx2, {#6} ty1, {#7} ty2, {#8} = c, mx, my
\newcommand*{\weakSwCsupgDD}[8]{
& \supgDA{#3}{#8}{#2} =  
\intg{    
\tauPG{#1} \lrbbb{ 
\deriv{\phidd{#3}}{x} \bigg( {#4}\residDA{#3}{}{*c} + {#5}\residDA{#3}{}{*mx} \bigg)  + 
\deriv{\phidd{#3}}{y} \bigg( {#6}\residDA{#3}{}{*c} + {#7}\residDA{#3}{}{*my} \bigg)
}       
 }{#1}{#2}
}
\newcommand*{\weakSwMXsupgDD}[8]{
& \supgDA{#3}{#8}{#2} =  
\intg{    
\tauPG{#1} \lrbbb{ 
\deriv{\phidd{#3}}{x} \bigg( {#4}\residDA{#3}{}{*c} + {#5}\residDA{#3}{}{*mx} \bigg)  + 
\deriv{\phidd{#3}}{y} \bigg( {#7}\residDA{#3}{}{*mx} \bigg)
}       
 }{#1}{#2}
}

\newcommand*{\weakSwMYsupgDD}[8]{
& \supgDA{#3}{#8}{#2} =  
\intg{    
\tauPG{#1} \lrbbb{ 
\deriv{\phidd{#3}}{y} \bigg( {#4}\residDA{#4}{}{*c} + {#5}\residDA{#3}{}{*my} \bigg)  + 
\deriv{\phidd{#3}}{x} \bigg( {#7}\residDA{#4}{}{*my} \bigg)
}       
 }{#1}{#2}
}


% Matrix Form
\newcommand*{\swMatrixForm}[1]{
\begin{align} 
\label{eqn:{#1}}
\mathbf{R}^* \equiv 
\frac{\partial \mathbf{Q}}{\partial{t}} + 
\frac{\partial \mathbf{F}_x}{\partial{x}} + 
\frac{\partial \mathbf{F}_y}{\partial{y}}  + 
\mathbf{\srcGen{}{}{}} = 0
\end{align}
}

% Matrix Form - nonconservative, linear
\newcommand*{\swMatrixFormNC}[1]{
\begin{align} 
\label{eqn:{#1}}
\mathbf{R}^{*}_{\,nc} \equiv 
\frac{\partial \mathbf{Q}_{\,nc}}{\partial{t}} + 
\mathbf{A}_x \frac{\partial \mathbf{Q}_{\,nc}}{\partial{x}} + 
\mathbf{A}_x \frac{\partial \mathbf{Q}_{\,nc}}{\partial{y}}  + 
\mathbf{\srcGen{nc}{}{}} = 0
\end{align}
}

% R
\newcommand*{\swMatrixDefR}[1]{
\begin{align} 
\label{eqn:{#1}}
\mathbf{R}^* \equiv  \left( \begin{array}{c} \residDA{}{}{*c} \\[2mm] \residDA{}{}{*mx} \\[2mm] \residDA{}{}{*my}\end{array} \right)
\end{align}
}

% Q
\newcommand*{\swMatrixDefQ}[1]{
\begin{align} 
\label{eqn:{#1}}
\mathbf{Q} \equiv  \left(\begin{array}{c}
\depth{} \\
[2mm] \ub{} \depth{} \\
[2mm] \vb{} \depth{} 
\end{array}\right)
\end{align}
}

% Q non-conservative, linear
\newcommand*{\swMatrixDefQNC}[1]{
\begin{align} 
\label{eqn:{#1}}
\mathbf{Q}_{\,nc} \equiv  \left(\begin{array}{c}
\depth{} \\
[2mm] \ub{} \\
[2mm] \vb{}  
\end{array}\right)
\end{align}
}

% FX
\newcommand*{\swMatrixDefFX}[1]{
\begin{align} 
\label{eqn:{#1}}
\mathbf{F}_x \equiv  \left (
\begin{array}{c} 
\ub{} \depth{} \\
[2mm]  \ub{2} \depth{} + \frac{1}{2} g \depth{2} - \depth{} \frac{\sigma_{xx}}{\rho} \\
[2mm]  \ub{} \, \vb{}  \depth{} - \depth{} \frac{\sigma_{yx}}{\rho} \end{array} 
\right)
\end{align}
}

% Fy
\newcommand*{\swMatrixDefFY}[1]{
\begin{align} 
\label{eqn:{#1}}
\mathbf{F}_y \equiv  \left(
\begin{array}{c} 
\vb{} \depth{} \\
[2mm] \ub{} \, \vb{} \depth{} - \depth{} \frac{\sigma_{xy}}{\rho} \\
[2mm] \vb{2} \depth{} + \frac{1}{2} g \depth{2} - \depth{} \frac{\sigma_{yy}}{\rho} \end{array}
\right)
\end{align}
}

% S
\newcommand*{\swMatrixDefS}[1]{
\begin{align} 
\label{eqn:{#1}}
\mathbf{S} \equiv  \left(\begin{array}{c}
0 \\
[2mm] g\,\depth{}\frac{\partial z_b}{\partial x} + g\,\depth{}\,\srcGen{x}{}{} \\
[2mm] g\,\depth{}\frac{\partial z_b}{\partial y} + g\,\depth{}\,\srcGen{y}{}{}
\end{array}\right)
\end{align}
}

% S nonconservative, linear
\newcommand*{\swMatrixDefSNC}[1]{
\begin{align} 
\label{eqn:{#1}}
\mathbf{S} \equiv  \left(\begin{array}{c}
0 \\
[2mm] g\,\frac{\partial z_b}{\partial x} + g\,\srcGen{x}{}{} \\
[2mm] g\,\frac{\partial z_b}{\partial y} + g\,\srcGen{y}{}{}
\end{array}\right)
\end{align}
}

% nonconservative Jacobi matrices
\newcommand*{\swMatrixDefANC}[1]{
\label{eqn:{#1}}
\begin{eqnarray}
\mathbf{A}_x &=& \frac{\partial \mathbf{F}_x}{\partial Q_{nc}} =  \left[\begin{array}{ccc}\ub{} & \depth{} & 0\\g & \ub{} & 0 \\0 & 0 & \ub{} \end{array}\right] \\
\mathbf{A}_y &=& \frac{\partial \mathbf{F}_y}{\partial Q_{nc}} =  \left[\begin{array}{ccc}\vb{} & 0 & \depth{}\\0 & \vb{} & 0 \\g & 0 & \vb{} \end{array}\right] \nonumber
\end{eqnarray}
}

% matrix variable definitions
\newcommand*{\swMatrixVars}[1]{
\label{eqn:{#1}}
\begin{eqnarray}
\residDA{}{}{*c} &=& \text{the strong depth-averaged continuity equation} \nonumber \\
\residDA{}{}{*mx,y}&=& \text{the strong depth-averaged momentum equations} \nonumber \\
\rho &=& \text{fluid density} \ \nonumber \\
g &=& \text{gravity} \ \nonumber \\
z_b &=& \text{bed elevation} \ \nonumber \\
\depth{} &=& \text{water depth} \ \nonumber \\
{\ub{},\vb{}} &=& \text{{x,y}-components of the depth-averaged velocity} \nonumber \\
\sigma _{ij} &=& \text{Reynold's stress tensor} \nonumber \\
\srcGen{x,y}{}{} &=& \text{momentum sources/sinks} \nonumber
\end{eqnarray}
}
  
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Weak SW-3D equations
% {#1} = include "e", {#2} = include i on basis function, {#3} = include discrete h
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\weakSWContSurDDD}[3]{
\resid{i}{}{c}  = & \sum_{e}  
\bigg[  
     -  \bodyConv{\,3d}{#1}{\phidd{#2}}{\vel^{#3}}
    +  \bcConv{sw}{#1}{\phidd{#2}}{\vel^{\,#3}}
    +  \bcConv{b}{#1}{\phidd{#2}}{\vel^{\,#3}}                                                                     \nonumber \\                   
&  +  \bcKinematic{\eta}{#1}{\phidd{#2}}{\eta^{\,{#3}}}{S_{\eta}^{\,#3}}
    +  \bodySUPG{\supg{#2}{c}{#1}} 
\bigg]
}

\newcommand*{\weakSWContBedDDD}[3]{
\resid{i}{}{c}  = & \sum_{e}  
\bigg[  
     -  \bodyConv{\,3d}{#1}{\phidd{#2}}{\vel^{#3}}
    +  \bcConv{sw}{#1}{\phidd{#2}}{\vel^{\,#3}}
    +  \bcConv{\eta}{#1}{\phidd{#2}}{\vel^{\,#3}}                                                                     \nonumber \\                   
&  +  \bcKinematic{b}{#1}{\phidd{#2}}{b^{\,{#3}}}{S_{b}^{\,#3}}
    +  \bodySUPG{\supg{#2}{c}{#1}} 
\bigg]
}

\newcommand*{\weakSWMxDDD}[3]{
\resid{i}{}{mx}  = & \sum_{e}  
\bigg[  
        \bodyTime{\,3d}{#1}{\phidd{#2}}{u^{\,#3}}
     -  \bodyConv{\,3d}{#1}{\phidd{#2}}{(\velr^{#3} \, u^{\,#3})}
     -  \bodyCoriolis{\,3d}{#1}{\phidd{#2}}{v^{\,#3}}                                                                \nonumber \\
&  -   \bodyPressure{\,3d}{#1}{\phidd{#2}}{x}{P^{\,#3}} 
    +  \bodyDiffusion{\,3d}{#1}{\phidd{#2}}{\diffTensor{x}{#3}{\diffTensorSW}{}}  
     -  \bcStress{\eta}{#1}{\phidd{#2}}{\lrpb{\tau_{winds,x}^{\,#3} + \tau_{waves,x}^{\,#3}}}   \nonumber \\
&  +  \bcConv{}{#1}{\phidd{#2}}{(\velr^{\,#3} \, u^{\,#3})}
    +  \bcPressure{}{#1}{\phidd{#2}}{P^{\,#3}}{x}
    -   \bcDiff{}{#1}{\phidd{#2}}{\diffTensor{x}{#3}{\diffTensorSW}{}}                                                                      \nonumber \\
&  +  \bcFriction{}{#1}{\phidd{#2}}{u^{\,#3}}{\vel^{\,#3}}
    +  \bodySUPG{\supg{#2}{mx}{#1}} 
\bigg]
}

\newcommand*{\weakSWMyDDD}[3]{
\resid{i}{}{my} = & \sum_{e}  
\bigg[  
       \bodyTime{\,3d}{#1}{\phidd{#2}}{v^{\,#3}}
    -  \bodyConv{\,3d}{#1}{\phidd{#2}}{(\velr^{#3} \, v^{\,#3})}
    + \bodyCoriolis{\,3d}{#1}{\phidd{#2}}{u^{\,#3}}                                                                  \nonumber \\
&  -  \bodyPressure{\,3d}{#1}{\phidd{#2}}{y}{P^{\,#3}} 
    +  \bodyDiffusion{\,3d}{#1}{\phidd{#2}}{\diffTensor{y}{#3}{\diffTensorSW}{}}  
     -  \bcStress{\eta}{#1}{\phidd{#2}}{\lrpb{\tau_{winds,y}^{\,#3} + \tau_{waves,y}^{\,#3}}}   \nonumber \\
&  +  \bcConv{}{#1}{\phidd{#2}}{(\velr^{\,#3} \, v^{\,#3})}
    +  \bcPressure{}{#1}{\phidd{#2}}{P^{\,#3}}{y}
     -  \bcDiff{}{#1}{\phidd{#2}}{\diffTensor{y}{#3}{\diffTensorSW}{}}                                                                      \nonumber \\
&   + \bcFriction{}{#1}{\phidd{#2}}{v^{\,#3}}{\vel^{\,#3}}
     + \bodySUPG{\supg{#2}{my}{#1}}
\bigg]
}

% 3D SW SUPG TERMS
% {#1} = 2d/3d, {#2} = include "e",  {#3} test function index, {#4} = c, mx, my, {#5} = upwind, {#6} Rc factor, {#8}  x,y
\newcommand*{\weakSwDACsupgDDD}[5]{
& \supgDA{#3}{#1,\,#4}{#2} =  
\intg{    
\tauPG{#1} \lrbbb{ 
(\dotp{#5}{\bnabla{#1}\phiddd{#2}}) \resid{i}{}{*c} + \deriv{\phiddd{#3}}{x} \resid{i}{}{*mx} + \deriv{\phiddd{#3}}{y} \resid{i}{}{*my} 
}       
 }{#1}{#2}
}
\newcommand*{\weakSwMXYsupgDDD}[7]{
& \supg{#3}{#1\,#4}{#2} =  
\intg{    
\tauPG{#1} \lrbbb{ 
(\dotp{#5}{\bnabla{#1}\phiddd{#3}}) \resid{i}{}{*mx} + {#6}\deriv{\phiddd{#3}}{#7} \resid{i}{}{*c} 
}       
 }{#1}{#2}
}
\newcommand*{\weakSwCsupgDDD}[4]{
& \supg{#3}{#1\,#4}{#2} =  \supgDA{#3}{#1,\,#4}{#2} - 
\intg{    
\tauPG{#1} \lrbbb{ 
\tauZ \deriv{\phiddd{#3}}{z} \resid{i}{}{*c} 
}       
 }{#1}{#2}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Weak Transport (Advection/Diffusion) Equation 
% {#1} 2d,3d, {#2} include "e", {#3} include "h", {#4} test function, {#5} variable, {#6} test function id, {#7} bl, sl, t, etc, {#8} con id 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\weakTrns}[8]{
\resid{#6}{#8,}{#7} = & \sum_{e}  
\bigg[  
        \bodyTime{\,#1}{#2}{#4}{#5}
     -  \bodyConv{\,#1}{#2}{#4}{ (\velc{#3}{#7} \, {#5}) }
    +  \bodyDiffusion{\,#1}{#2}{#4}{\diffTensor{#7}{#3}{\diffTensorTRN}{#8,}}                               \nonumber \\
&  -   \bodySource{\,#1}{#2}{#4}{\srcGen{#7}{#3}{#8,}}
    +  \bcConv{}{#2}{#4}{(\velc{#3}{#7} \, {#5} }
    -   \bcDiff{}{#2}{#4}{\diffTensor{#7}{#3}{\diffTensorTRN}{#8,}}                                                     
    +  \bodySUPG{\supg{#6}{#7}{#2}} 
\bigg]
}





